apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * Configurações do React Native Gradle Plugin (RNGP).
 * Normalmente você não precisa mudar nada aqui além do autolink.
 * Doc: https://reactnative.dev/docs/react-native-gradle-plugin
 */
react {
    /* Autolinking (detecta e linka libs RN automaticamente) */
    autolinkLibrariesWithApp()

    // Exemplos de opções (deixe comentado se não precisar):
    // nodeExecutableAndArgs = ["node"]
    // bundleCommand = "bundle"
    // entryFile = file("../index.js")
    // extraPackagerArgs = []
    // hermesFlags = ["-O", "-output-source-map"]
}

/** Ativar ProGuard/shrinker no release (mantenho desligado por padrão) */
def enableProguardInReleaseBuilds = false

/**
 * Caso Hermes esteja desabilitado, usa JSC.
 * (Mantive a mesma versão que você já tinha.)
 */
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
    /** As versões vêm do rootProject.ext (android/build.gradle) */
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    /** Namespace (substitui applicationId no manifest) */
    namespace "com.sfismobile2"

    defaultConfig {
        applicationId "com.sfismobile2"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"

        // Permite HTTP claro (só mantenha em dev/QA; avalie HTTPS em produção)
        manifestPlaceholders = [
            usesCleartextTraffic: "true"
        ]
    }

    /**
     * Java/Kotlin no 17 (alinha com JDK 17 que você está usando)
     */
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = '17'
    }

    /**
     * Assinaturas: debug (padrão) e release (com sua keystore).
     * As credenciais são lidas do gradle.properties para não vazar no Git.
     * Doc oficial: https://reactnative.dev/docs/signed-apk-android
     */
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            // Usa as variáveis definidas no gradle.properties
            if (project.hasProperty('MYAPP_UPLOAD_STORE_FILE')) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
                // storeType 'pkcs12' // opcional, o keytool já gerou PKCS12
            }
        }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
                    // APK assinado com sua keystore de release
                    signingConfig signingConfigs.release

                    // Otimizações (pode ativar mais tarde)
                    minifyEnabled false
                    shrinkResources false

                    // Arquivos de regras para o shrinker/ProGuard
                    proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"

                    // Opcional: se for distribuir um único APK com ABIs específicas
                    // ndk {
                    //     abiFilters "armeabi-v7a", "arm64-v8a"
                    // }
                }
            }

            /**
             * Gera um APK separado por arquitetura (vários arquivos menores)
             * Ideal para distribuição fora da Play Store.
             */
            splits {
                abi {
                    reset()
                    enable true
                    universalApk false // não gera um único APK com tudo
                    include "armeabi-v7a", "arm64-v8a", "x86_64"
                }
            }

            /**
             * (Opcional) evitar conflitos de libs nativas.
             * Deixe desativado se não precisar.
             */
            // packagingOptions {Ò
            //     jniLibs {
            //         useLegacyPackaging = true
            //     }
            // }
        }

dependencies {
    // A versão do react-android é gerenciada pelo plugin do RN
    implementation("com.facebook.react:react-android")

    // Hermes por padrão (controlado por 'hermesEnabled' no gradle.properties)
    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}
