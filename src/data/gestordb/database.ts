import SQLite, {
  type ResultSet,
  type SQLiteDatabase,
  type Transaction,
} from 'react-native-sqlite-storage';

SQLite.enablePromise(true);

const DB_NAME = 'DBDSNSFISMobile.db';
const DB_LOCATION = 'default';

let dbInstance: SQLiteDatabase | null = null;

const TABLE_DEFINITIONS: string[] = [
  `CREATE TABLE IF NOT EXISTS LOGATUALIZACAO (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    DATAEMPRESASAUTORIZADAS TEXT,
    DATAEQUIPE TEXT,
    DATAIRREGULARIDADES TEXT,
    DATAQUESTIONARIOS TEXT,
    DATAPERGUNTAS TEXT,
    DATAPERGUNTASIRREGULARIDADES TEXT,
    DATAINSTALACAOPORTUARIA TEXT,
    DATATRECHOLINHATIPOTRANSPORTE TEXT,
    DATAFROTAALOCADA TEXT,
    DATAMENSAGEMPUSH TEXT,
    DATAESQUEMASOPERACIONAIS TEXT,
    DATAPRESTADORESSERVICOS TEXT,
    DATAMUNICIPIOS TEXT,
    DATATIPOTRANSPORTE TEXT,
    DATATRECHOLINHA TEXT,
    DATAEMBARCACOESINTERIOR TEXT,
    DATAFISCALIZACOESREALIZADAS TEXT,
    CHAVE TEXT UNIQUE,
    CURSOR TEXT,
    ATUALIZADOEM TEXT NOT NULL
  )`,
  `CREATE TABLE IF NOT EXISTS LOGERRO (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NOUSUARIO TEXT,
    NRMATRICULA TEXT,
    DTREGISTRO TEXT,
    TELAREFERENCIA TEXT,
    ACAO TEXT,
    DESCRICAOERRO TEXT,
    PARAMETROS TEXT,
    FLAGENVIADA TEXT,
    CONTEXTO TEXT,
    MENSAGEM TEXT,
    PAYLOAD TEXT,
    CRIADOEM TEXT NOT NULL
  )`,
  `CREATE TABLE IF NOT EXISTS EMPRESASAUTORIZADAS (
    ID INTEGER PRIMARY KEY,
    AREAPPF TEXT,
    DSBAIRRO TEXT,
    DSENDERECO TEXT,
    DTADITAMENTO TEXT,
    DTOUTORGA TEXT,
    EMAIL TEXT,
    INSTALACAO TEXT,
    INSTALACAOSEMACENTOS TEXT,
    LISTATIPOEMPRESA TEXT,
    MODALIDADE TEXT,
    NOMUNICIPIO TEXT,
    NORAZAOSOCIAL TEXT,
    NRADITAMENTO TEXT,
    NRCEP TEXT,
    NRINSCRICAO TEXT,
    NRINSTRUMENTO TEXT,
    NOMECONTATO TEXT,
    QTDEMBARCACAO INTEGER,
    SGUF TEXT,
    TPINSCRICAO TEXT,
    IDCONTRATOARRENDAMENTO TEXT,
    VLMONTANTEINVESTIMENTO TEXT,
    NRTLO TEXT,
    NRRESOLUCAO TEXT,
    AUTORIDADEPORTUARIA TEXT,
    NRINSCRICAOINSTALACAO TEXT,
    NORAZAOSOCIALINSTALACAO TEXT,
    NOREPRESENTANTE TEXT,
    NRTELEFONE TEXT,
    EEREPRESENTANTE TEXT,
    NRDOCUMENTOSEI TEXT,
    PAYLOAD TEXT NOT NULL
  )`,
  `CREATE TABLE IF NOT EXISTS FROTAALOCADA (
    ID INTEGER PRIMARY KEY,
    IDFROTA TEXT,
    TPINSCRICAO TEXT,
    IDEMBARCACAO TEXT,
    STEMBARCACAO TEXT,
    DTINICIO TEXT,
    DTTERMINO TEXT,
    TPAFRETAMENTO TEXT,
    STREGISTRO TEXT,
    IDFROTAPAI TEXT,
    STHOMOLOGACAO TEXT,
    NOEMBARCACAO TEXT,
    NRCAPITANIA TEXT,
    TIPOEMBARCACAO TEXT,
    NRINSCRICAO TEXT,
    NRINSTRUMENTO TEXT,
    PAYLOAD TEXT NOT NULL
  )`,
  'CREATE INDEX IF NOT EXISTS IDX_EMPRESAS_NR ON EMPRESASAUTORIZADAS(NRINSCRICAO)',
  'CREATE INDEX IF NOT EXISTS IDX_EMPRESAS_MODALIDADE ON EMPRESASAUTORIZADAS(MODALIDADE)',
  'CREATE INDEX IF NOT EXISTS IDX_EMPRESAS_UF ON EMPRESASAUTORIZADAS(SGUF)',
  'CREATE INDEX IF NOT EXISTS IDX_EMPRESAS_MUNICIPIO ON EMPRESASAUTORIZADAS(NOMUNICIPIO)',
  'CREATE INDEX IF NOT EXISTS IDX_FROTA_EMPRESA ON FROTAALOCADA(NRINSCRICAO, NRINSTRUMENTO)',
];

const COLUMN_ALTERATIONS: string[] = [
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN DSBAIRRO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN DSENDERECO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN DTADITAMENTO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN DTOUTORGA TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN EMAIL TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRADITAMENTO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRCEP TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NOMECONTATO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN IDCONTRATOARRENDAMENTO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN VLMONTANTEINVESTIMENTO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRTLO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRRESOLUCAO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN AUTORIDADEPORTUARIA TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRINSCRICAOINSTALACAO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NORAZAOSOCIALINSTALACAO TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NOREPRESENTANTE TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRTELEFONE TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN EEREPRESENTANTE TEXT',
  'ALTER TABLE EMPRESASAUTORIZADAS ADD COLUMN NRDOCUMENTOSEI TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN ID INTEGER',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAEMPRESASAUTORIZADAS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAEQUIPE TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAIRREGULARIDADES TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAQUESTIONARIOS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAPERGUNTAS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAPERGUNTASIRREGULARIDADES TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAINSTALACAOPORTUARIA TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATATRECHOLINHATIPOTRANSPORTE TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAFROTAALOCADA TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAMENSAGEMPUSH TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAESQUEMASOPERACIONAIS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAPRESTADORESSERVICOS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAMUNICIPIOS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATATIPOTRANSPORTE TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATATRECHOLINHA TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAEMBARCACOESINTERIOR TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN DATAFISCALIZACOESREALIZADAS TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN CHAVE TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN CURSOR TEXT',
  'ALTER TABLE LOGATUALIZACAO ADD COLUMN ATUALIZADOEM TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN NOUSUARIO TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN NRMATRICULA TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN DTREGISTRO TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN TELAREFERENCIA TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN ACAO TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN DESCRICAOERRO TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN PARAMETROS TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN FLAGENVIADA TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN CONTEXTO TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN MENSAGEM TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN PAYLOAD TEXT',
  'ALTER TABLE LOGERRO ADD COLUMN CRIADOEM TEXT'
];

export async function openDatabaseAsync(): Promise<SQLiteDatabase> {
  if (dbInstance) {
    return dbInstance;
  }

  dbInstance = await SQLite.openDatabase({ name: DB_NAME, location: DB_LOCATION });
  return dbInstance;
}

export async function migrateAsync(): Promise<void> {
  const db = await openDatabaseAsync();
  for (const statement of TABLE_DEFINITIONS) {
    await db.executeSql(statement);
  }
  for (const statement of COLUMN_ALTERATIONS) {
    try {
      await db.executeSql(statement);
    } catch (error) {
      const message = (error as Error)?.message ?? '';
      if (!message.toLowerCase().includes('duplicate column name')) {
        throw error;
      }
    }
  }
}

export async function runAsync(sql: string, params: Array<string | number | null> = []): Promise<void> {
  const db = await openDatabaseAsync();
  await db.executeSql(sql, params);
}

function mapRows<T>(result: ResultSet): T[] {
  const rows: T[] = [];
  for (let i = 0; i < result.rows.length; i += 1) {
    rows.push(result.rows.item(i));
  }
  return rows;
}

export async function getAsync<T>(sql: string, params: Array<string | number | null> = []): Promise<T | null> {
  const db = await openDatabaseAsync();
  const [result] = await db.executeSql(sql, params);
  if (!result || result.rows.length === 0) {
    return null;
  }
  return result.rows.item(0) as T;
}

export async function allAsync<T>(sql: string, params: Array<string | number | null> = []): Promise<T[]> {
  const db = await openDatabaseAsync();
  const [result] = await db.executeSql(sql, params);
  if (!result) {
    return [];
  }
  return mapRows<T>(result);
}

export async function txAsync<T>(fn: (tx: Transaction) => Promise<T> | T): Promise<T> {
  const db = await openDatabaseAsync();

  return new Promise<T>((resolve, reject) => {
    let resultValue: T;

    db.transaction(
      tx => {
        const maybePromise = fn(tx);
        Promise.resolve(maybePromise)
          .then(value => {
            resultValue = value;
          })
          .catch(error => {
            reject(error);
            throw error;
          });
      },
      error => {
        reject(error);
      },
      () => {
        resolve(resultValue);
      },
    );
  });
}

export async function closeDatabaseAsync(): Promise<void> {
  if (dbInstance) {
    await dbInstance.close();
    dbInstance = null;
  }
}
